#!/usr/bin/env sh

FNX_BINARY_PATH=":FNX_BINARY_PATH"
FNX_CONFIG_FILE_PATH=":FNX_CONFIG_FILE_PATH"
FNX_DATA_DIRECTORY=":FNX_DATA_DIRECTORY"

FNX_CORE_MODE=":FNX_CORE_MODE"
FNX_CORE_PATH=":FNX_CORE_PATH"

SHOULD_TRAP=$(FNX_BINARY_PATH=$FNX_BINARY_PATH \
                FNX_CONFIG_FILE_PATH=$FNX_CONFIG_FILE_PATH \
                FNX_DATA_DIRECTORY=$FNX_DATA_DIRECTORY \
                FNX_CORE_MODE=$FNX_CORE_MODE \
                FNX_CORE_PATH=$FNX_CORE_PATH \
                fennel --add-fennel-path $FNX_CORE_PATH/?.fnl $FNX_CORE_PATH/run/cli.fnl trap "$@")

if [ "$SHOULD_TRAP" == "t" ]; then
  FNX_BINARY_PATH=$FNX_BINARY_PATH \
    FNX_CONFIG_FILE_PATH=$FNX_CONFIG_FILE_PATH \
    FNX_DATA_DIRECTORY=$FNX_DATA_DIRECTORY \
    FNX_CORE_MODE=$FNX_CORE_MODE \
    FNX_CORE_PATH=$FNX_CORE_PATH \
    fennel --add-fennel-path $FNX_CORE_PATH/?.fnl $FNX_CORE_PATH/run/cli.fnl "$@"
else
  FNX_BINARY_PATH=$FNX_BINARY_PATH \
    FNX_CONFIG_FILE_PATH=$FNX_CONFIG_FILE_PATH \
    FNX_DATA_DIRECTORY=$FNX_DATA_DIRECTORY \
    FNX_CORE_MODE=$FNX_CORE_MODE \
    FNX_CORE_PATH=$FNX_CORE_PATH \
    fennel$(
      FNX_BINARY_PATH=$FNX_BINARY_PATH \
      FNX_CONFIG_FILE_PATH=$FNX_CONFIG_FILE_PATH \
      FNX_DATA_DIRECTORY=$FNX_DATA_DIRECTORY \
      FNX_CORE_MODE=$FNX_CORE_MODE \
      FNX_CORE_PATH=$FNX_CORE_PATH fennel --add-fennel-path $FNX_CORE_PATH/?.fnl $FNX_CORE_PATH/run/cli.fnl inject "$@") "$@"
fi
